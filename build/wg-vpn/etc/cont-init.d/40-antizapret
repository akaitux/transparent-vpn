#!/command/with-contenv bash
if [[ "$ANZ_DISABLED" == *"yes"* ]]; then
    echo "### Pass antizapret ####"
    exit 0
fi
if [[ ! -f /opt/antizapret/config/config.sh ]] || [[ "$ANZ_REBUILD_CONFIG" == *"yes"* ]]; then
    echo "#### Init antizapret ####"
    mkdir -p /opt/antizapret/config

    cp -n /opt/antizapret/config_default/config.sh /opt/antizapret/config/

    if [[ "$ANZ_RESOLVE_NXDOMAIN" == *"yes"* ]]; then
        sed -i -e 's/RESOLVE_NXDOMAIN=.*/RESOLVE_NXDOMAIN="yes"/g' /opt/antizapret/config/config.sh
    else
        sed -i -e 's/RESOLVE_NXDOMAIN=.*/RESOLVE_NXDOMAIN="no"/g' /opt/antizapret/config/config.sh
    fi

    cp -n /opt/antizapret/config_default/* /opt/antizapret/config/
fi

chown -R vpn:vpn /opt/antizapret
chown vpn:vpn /etc/knot-resolver/aliases/aliases.conf
su - vpn -c '/opt/antizapret/doall.sh' &
